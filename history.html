<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>History</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: rgb(30, 110, 233);
    }

    .booking-container {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 400px;
    }

    button {
      display: block;
      width: 100%;
      padding: 0.75rem;
      background-color: rgb(30, 110, 233);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

  .switch-tabs {
	  display: flex;
	  margin-bottom: 1rem;
	}
	
	.switch-tab {
	  background-color: white;
	  color: rgb(30, 110, 233);
	  border: none;
	  outline: none;
	  cursor: pointer;
	  padding: 0.5rem 1rem;
	  transition: background-color 0.3s ease;
	}
	
	.switch-tab.active {
	  background-color: rgb(30, 110, 233);
	  color: white;
	}

	.card-container {
	  display: grid;
	  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
	  grid-gap: 1.5rem;
	}
	
	.card {
	  background-color: white;
	  padding: 1.5rem;
	  border-radius: 8px;
	  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
	}
	
	.card-header {
	  font-size: 1.2rem;
	  font-weight: bold;
	  margin-bottom: 0.5rem;
	}
	
	.card-content {
	  font-size: 0.9rem;
	  color: #666;
	}
	
	.card-info {
	  margin-top: 0.5rem;
	}
	  
  </style>
</head>
<body>
  <div class="booking-container">
	  <div class="switch-tabs">
	      <button class="switch-tab">BOOK</button>
	      <button class="switch-tab active">HISTORY</button>
	    </div>
	
	    <!-- Booking content goes here -->
	    <div class="booking-content">
	      <!-- Booking form or other content -->
	    </div>

    <!-- History content goes here -->
    <div class="history-content" style="display: none;">
      <!-- History table or other content -->
    </div>
	  
    <div class="booking-content">
      <div class="card-container">
        <!-- Cards will be dynamically added here -->
      </div>
    </div>
	  
  </div>

  
<script type="module">

    // Retrieve the username from the query parameters
    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('username');
	const phone = urlParams.get('phone');


	// Switch Tabs
	const switchTabs = document.querySelectorAll('.switch-tab');
	const bookingContent = document.querySelector('.booking-content');
	
	function setActiveTab() {
	  // Check the current URL to determine the active tab
	  const currentURL = window.location.href;
	  if (currentURL.includes('history.html')) {
	    // The "HISTORY" tab is active
	    switchTabs.forEach((tab, index) => {
	      tab.classList.remove('active');
	      if (index === 1) {
		tab.classList.add('active');
	      }
	    });
	    bookingContent.style.display = 'none';
	  } else {
	    // The "BOOK" tab is active
	    switchTabs.forEach((tab, index) => {
	      tab.classList.remove('active');
	      if (index === 0) {
		tab.classList.add('active');
	      }
	    });
	    bookingContent.style.display = 'block';
	  }
	}
	
	switchTabs.forEach((tab, index) => {
	  tab.addEventListener('click', (event) => {
	    // Remove the active class from all tabs
	    switchTabs.forEach((t) => t.classList.remove('active'));
	
	    // Add the active class to the clicked tab
	    tab.classList.add('active');
	
	    // If the clicked tab is the "BOOK" tab (index 0), navigate to the booking.html page
	    if (index === 0) {
	      setActiveTab();
	      window.location.href = 'booking.html';
	    } else {
	      // Show the booking content
	      bookingContent.style.display = 'block';
	    }
	  });
	});
	
	// Set the initial active tab
	setActiveTab();

async function displayHistory() {
	let paxList = [];
	
	const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTxjHHSDdcYUEZMbCzUF_yov6p3Ur1nEdkGbMtaNrco6O8dQG5WLtM7YxloG8rbsZH--9J75SJWyrzR/pub?output=csv';
	console.log("bookings lookup check")
	fetch(sheetUrl)
	  .then(response => response.text())
	  .then(data => {
	    console.log("lookup responsed")
	    // Parse the CSV data
	    const rows = data.trim().split('\n');
	    const headers = rows[0].split(',').map(header => header.replace('\r', ''));
	    const dataRows = rows.slice(1);
	    for (let i = 0; i < dataRows.length; i++) {
		    const matchedRowValues = dataRows[i].split(',').map(data => data.replace('\r', '').replace('"', ''));  
			    console.log("matchedRowValues: ",matchedRowValues)
			const username = matchedRowValues[headers.indexOf('username')];
		        const paxphone = matchedRowValues[headers.indexOf('phone')];
		    	console.log("Now compare: ", paxRouteID,paxdate, paxtime)  
			if (username === name && paxphone === phone) {
			      const paxcount = Number(matchedRowValues[headers.indexOf('passengers')]);
			      const paxChecked = matchedRowValues[headers.indexOf('check')];
			      console.log("pax found. count: ",paxcount)
			      bookedPaxCount = parseInt(bookedPaxCount) + parseInt(paxcount)
				console.log("Acc count: ",bookedPaxCount)
				const paxRoutePickup = matchedRowValues[headers.indexOf('pickup')];
				const paxRouteDropoff = matchedRowValues[headers.indexOf('dropoff')];
			    	const paxdate = matchedRowValues[headers.indexOf('date')];
			    	const paxtime = matchedRowValues[headers.indexOf('time')];
			    	const paxOnBoardStop = matchedRowValues[headers.indexOf('midstops')];
		    		
				// insert to pax list
				paxList.push({
				  paxname: paxname,
				  paxphone: paxphone,
				  routeID: paxRouteID,
				  pickup: paxRoutePickup,
				  dropoff: paxRouteDropoff,
				  onBoardStop: paxOnBoardStop,
				  date: paxdate,
				  time: paxtime,
				  paxcount: paxcount,
				  checkedin: paxChecked,
				  rowIndex: i+2,
				  listIndex: j
				});
				j = j+1;
			}
		    }	


	// Display history record cards
	const cardContainer = document.querySelector('.card-container');
	const username = 'your_username'; // Replace with the actual username
	
	function displayMatchedRecords() {
	  cardContainer.innerHTML = '';
	
	  paxList.forEach((item) => {
	    if (item.paxname === username && (new Date(item.date) >= new Date())) {
	      const card = document.createElement('div');
	      card.classList.add('card');
	
	      const cardHeader = document.createElement('div');
	      cardHeader.classList.add('card-header');
	      cardHeader.textContent = `From: ${item.pickup} - To: ${item.dropoff}`;
	
	      const cardContent = document.createElement('div');
	      cardContent.classList.add('card-content');
	      cardContent.innerHTML = `
	        On-board stop: ${item.onBoardStop}<br>
	        Date: ${item.date}<br>
	        Time: ${item.time}
	      `;
	
	      const cardInfo = document.createElement('div');
	      cardInfo.classList.add('card-info');
	      cardInfo.innerHTML = `
	        Pax Count: ${item.paxcount}<br>
	        Booking Number: ${item.paxphone}
	      `;
	
	      card.appendChild(cardHeader);
	      card.appendChild(cardContent);
	      card.appendChild(cardInfo);
	      cardContainer.appendChild(card);
	    }
	  });
	}
	
	// Call the displayMatchedRecords function to display the cards
	displayMatchedRecords();
   })
}
displayHistory();

		
  </script>
</body>
</html>
