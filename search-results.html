
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Shuttle</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: rgb(30, 110, 233);
    }

    .search-results-container {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 400px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    input, select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      display: block;
      width: 100%;
      padding: 0.75rem;
      background-color: rgb(30, 110, 233);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
	
	#search-info-container {
	  display: flex;
	  flex-direction: column;
	  gap: 10px;
	}

	.search-info-item {
	  display: flex;
	  align-items: center;
	  font-size: 48px;
	  font-weight: bold;
	  color: rgb(30, 110, 233);
	}

	.search-info-item label {
	  font-weight: bold;
	  color: black
	}
	table {
	  margin: 0 auto;
	  text-align: left;

	th, td {
	  padding: 8px;	
	  text-align: left;
	  border-bottom: 1px solid #ddd;
	}
  </style>
</head>
<body>
  <div class="search-results-container">
    <h1>Select Shuttle</h1>
	<div id="search-info-container">
	  <div class="search-info-item">
	  <table><tr>
	  <th>

		<span id="pickup-location">N/A</span>
		</th>
	  </div>
	  <th><label> - </label></th>
	  <th>
	  <div class="search-info-item">

		<span id="dropoff-location">N/A</span>
	  </th></tr></table>
	  </div>
	</div>
	
	<div id="details">
	<label>Frequency: </label>
	<span id="frequency-days">N/A</span>
	<span id="frequency-minutes">N/A</span>
	<br>
	<span id="timef">N/A</span>
	<span id="stopf">N/A</span>
	<span id="idf">N/A</span>
	</div>
	<br>
    <button id="view-details-btn">View Details</button>
	
	<p>Book a future bus ride</p>
	  <div>
		<label for="date-selector">Date:</label>
		<input type="date" id="date-input" min="" value="">
	  </div>
	  <div>
		<label for="time-selector">Time:</label>
		<select id="time-selector"></select>
	  </div>
	  <div>
		<label for="passengers-selector">Passengers:</label>
		<input type="number" id="passengers-selector" min="1" value="1">
	  </div>
	  <div>
		<label for="midstops-selector">Midstops:</label>
		<select id="midstops-selector"></select>
	  </div>
	  
	  <br>
	  <button id="book-button">BOOK</button>
  </div>

<script>
  
    // Retrieve the query parameters
    const urlParams = new URLSearchParams(window.location.search);
    const pickupLocation = urlParams.get('pickup');
    const dropoffLocation = urlParams.get('dropoff');
	const username = urlParams.get('username');
	const phone = urlParams.get('phone');

    // Display the search information
	const pickupLocationElement = document.getElementById('pickup-location');
	const dropoffLocationElement = document.getElementById('dropoff-location');

	pickupLocationElement.textContent = pickupLocation || 'N/A';
	dropoffLocationElement.textContent = dropoffLocation || 'N/A';
	
	// Get the current date
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const currentDate = `${year}-${month}-${day}`;

    // Set the default value and minimum date
    const dateInput = document.getElementById('date-input');
    dateInput.value = currentDate;
    dateInput.min = currentDate;
	
	// Add an event listener to format the input value
    dateInput.addEventListener('input', function() {
      const inputValue = this.value;
      const parts = inputValue.split('-');
      if (parts.length === 3) {
        const day = parts[2];
        const month = parts[1];
        const year = parts[0];
        this.value = `${year}-${month}-${day}`;
      }
	});
	
	 
</script>
<script type="module">
    import { getRoutes } from './routes.js';
	import { appendToGoogleSheet } from './routes.js';
	
    async function displayFrequencyDetails() {
      const routes = await getRoutes();

      // Get the pickup and dropoff locations from the HTML
      const pickupLocationElement = document.getElementById('pickup-location');
      const dropoffLocationElement = document.getElementById('dropoff-location');
      const pickupLocation = pickupLocationElement.textContent;
      const dropoffLocation = dropoffLocationElement.textContent;

      const frequencyDaysElement = document.getElementById('frequency-days');
      const frequencyMinutesElement = document.getElementById('frequency-minutes');
      
      const timeff = document.getElementById('timef');
      const stopff = document.getElementById('stopf');
      const idff = document.getElementById('idf');
      
      const viewDetailsButton = document.getElementById('view-details-btn');
      const timeSelector = document.getElementById('time-selector');
      const midsStopsSelector = document.getElementById('midstops-selector');

      let foundMatch = false;
      let matchedRouteId;
      let matchedDepartureTimes = [];
      let matchedMidstops = [];
      routes.forEach(route => {
        if (route.From === pickupLocation && route.To === dropoffLocation) {
          foundMatch = true;
          matchedRouteId = route.id;
          frequencyDaysElement.textContent = `${route.departureFrequency.days}, `;
          frequencyMinutesElement.textContent = `${route.departureFrequency.minutes}`;
          // Split the departure times by semicolon and trim the values
          matchedDepartureTimes = route.DepartureTime.map(time => time.trim());
          matchedMidstops = route.Midstops.map(midstop => midstop.trim());
          timeff.textContent = route.DepartureTime.join(', ');
          stopff.textContent = route.Midstops.join(', ');
          idff.textContent = route.id;
        }
      });

      if (foundMatch) {
        viewDetailsButton.style.display = 'inline-block';
        viewDetailsButton.addEventListener('click', () => viewRouteDetails(pickupLocation, dropoffLocation, matchedRouteId));
		
		
        
        // Populate the time selector with the departure times
        timeSelector.innerHTML = 'Select time';
        matchedDepartureTimes.forEach(time => {
          const option = document.createElement('option');
          option.value = time;
          option.text = time;
          timeSelector.add(option);
        });
        
        // Populate the midstop selector with the midstops
        midsStopsSelector.innerHTML = 'Select midstop';
        matchedMidstops.forEach(midstop => {
          const option = document.createElement('option');
          option.value = midstop;
          option.text = midstop;
          midsStopsSelector.add(option);
        });
		
		
		// Add a click event listener to the "BOOK" button
	  const bookButton = document.getElementById('book-button');
	  bookButton.addEventListener('click', function() {
		const selectedDate = dateInput.value;
		const formattedDate = selectedDate.replace(/-/g, '/');
		const selectedTime = document.getElementById('time-selector').value;
		const passengers = document.getElementById('passengers-selector').value;
		const midstops = document.getElementById('midstops-selector').value;
		//const idfff = document.getElementById('idf').value;

		const queryParams = new URLSearchParams({
		  username: username,
		  phone:phone,
		  id: matchedRouteId,
		  pickup: pickupLocation,
          dropoff: dropoffLocation,
		  midstops: midstops,
		  date: formattedDate,
		  time: selectedTime,
		  passengers: passengers
		});
		
		
		
		
		
		// Append the data to the Google Sheet
		const spreadsheetId = '15EUV2jxrtympFa69tzhL7OiKnvEJx6N6bGueyUYAW5w';
		const range = 'Sheet1!A2:I2';
		const values = [[username, phone, matchedRouteId, pickupLocation, dropoffLocation, midstops, formattedDate, selectedTime, passengers]];

		// Initialize the Google API client and append the data
		gapi.load('client', async () => {
		  try {
			await appendToGoogleSheet(spreadsheetId, range, values);
			// Redirect the user to the boarding.html page
			window.location.href = `boarding.html?${queryParams.toString()}`;
		  } catch (error) {
			console.error('Error appending data to Google Sheet:', error);
		  }
		});

		
		
		
		
		
	  });
	
		
      } else {
        frequencyDaysElement.textContent = 'N/A';
        frequencyMinutesElement.textContent = 'N/A';
        viewDetailsButton.style.display = 'none';
        timeSelector.innerHTML = '';
        midsStopsSelector.innerHTML = '';
      }
    }

    function viewRouteDetails(pickupLocation, dropoffLocation, routeId) {
      window.location.href = `route_details.html?pickupLocation=${encodeURIComponent(pickupLocation)}&dropoffLocation=${encodeURIComponent(dropoffLocation)}&id=${routeId}`;
    }

    displayFrequencyDetails();
	

		
  </script>
</body>
</html>
